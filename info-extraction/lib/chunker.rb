

#document = "and well the I'm sorry to hear that you're having this that you're experiencing this is myalgias in this this this neuropathy chances are on this is a side effect for a toxicity associated with the the the taxol and a tweet we do see this every now and then to be going to last forever if we decide to stop the medication but that's a decision that you know that we can we can talk more about the good news today is that I reviewed your your CT scan from last week and I'm in your disease status appears to be stable based on the results of that that CT Imaging from last week getting any better you're not getting any worse"
#document = "May I come in nice to see you again? Nice to see you. Thank you. Have you been not so well tell me why well, as you know, I've started this new medication and I'm having a lot of side effects numbness muscle aches tingling in my fingers. I mean trouble with my daily activities walking dressing showering starting to use a cane feel a little better if I rest or take a warm bath so want to know what's causing these aches and numbness tingling how long these symptoms my last and my cancer is doing overall. Well, I'm sorry to hear all that the symptoms that you're having are.a typicalEverybody gets all of them and I wish I had a good answer about how long they will last for most people they eventually go away but that could be months to even a year before they go away. It sounds like you're doing all the right things you're paying attention recognizing how it's limiting you adjusting what you need to do to try to deal with those symptoms. Do you have any needs that are not being met in terms of your activities of daily living? Well, I managed my spouse takes care of me great. I'm glad to hear that. Do you foresee any limitations that you're going to have? Well, my sailing team is going to be able to do without me.I hope you'll be able to cheer.The shore thank you. The I did want to update you on what we have from testing. You had another CT as you know, and what that CT showed is that the nodules the lumps that you have in your lungs are exactly the same as they were before. They haven't gotten worse and they haven't gotten better. Right and that's not as much as we would hope for from taxol, but it is better than many people achieve. So you have that context. So are you are there any other therapies that you might recommend not now than at some point based on some triggering events? It's why I wish I were an oncologist. Yes. There are several other therapies none as quite as effective as taxol.but based onIf your disease begins to progress at a further CT, which I would recommend in three months, then we would discuss those at that point. You know, I think what another operation be warranted. I don't think so at this point. I think what's really important is to focus on how you want to live your life and for us to try to optimize your ability to do that as best we can thanks and so then can I expect these symptoms to last as long as I'm taking these medications? Yes. Yes, you can. Okay. Well, I know we talked about this before but I guess it's always a question if the symptoms are worse than the disease. Yes, I my opinion formy many years in practice"
#document = "Hi. Mrs. Ortiz. Great to see you again. Nice to see you again doctor. So the last time I think I saw you was about six weeks ago and I had started some new chemotherapy medicines accommodation of taxol and herceptin. So after I started taking them, I started experiencing muscle aches in my shoulders arms and legs and also some numbness and tingling in my fingers hands toes and feet and I guess my question for you while it and they've actually gotten sort of progressively worse since I started on these medications. So I guess my question for you is what is this to be expected or is this unusual you that's the perfect question it is to be expected from it's a known side effect of taxol. Okay different people.Experience it two very different.So it's pretty rare that somebody doesn't have these side effects and it's the level of side effect that you're having is pretty typical Our concern when people have these side effects as whether they get bad enough to interfere with your ability to take care of yourself. Well actually to a certain extent they have because the seem to be getting more severe and it's getting difficult to say take a morning shower and get dressed and I have to walk down to the end of the driveway to get my mail and I've been actually having to use a cane to do that and I've noticed that if I rest or take a warm bath, it seems to diminish the symptoms somewhat and makes me feel better. So I don't know if they're any other recommendations that you would have to kind of help treat the symptoms. So this is great that you've been able toobserve yourself andModifications that have helped you and I would say Bravo keep doing that keep doing that kind of self-observation understanding by trial and error. Okay. Well what makes your symptoms better, there isn't a medical recommendation that I could make to you. It's just going to be a matter of you're figuring out how to get through your day with the tasks that you have to do in the best way possible. Okay. So I my concern is like since the symptoms of beginning worse. Is this sort of a plateau that I will reach at some point or is it like how how quickly or what's the time course of the progression of the symptom? Yep. What's your future look like? Yeah. What's the yeah, exactly. And so I'm in that uncomfortable place that doctors are all the time by saying well, it depends and well, there's a range of ways that this couldthe most common thing is thatWe finished the tax all your symptoms will get better and at least half of people symptoms go away completely for life and the other half still have a little residual but nothing like the degree that you're experiencing now. Okay. Well that sounds good. The things will get better that's gives me hope. Yeah, how would you say my cancer is doing overall? Well, the best way we have to look at that is the CT scan because we're trying to look at the effect of the attack saw and the herceptin on that nodule in your lung and the results of that scan word that things have stayed exactly as they have been so the nodules not getting bigger. Okay. It's also not getting smaller we would and I will interpret that as good news because the purpose of the chemotherapy was to stopFrom getting bigger because that's what was happening before.Of course, we hoped it would get smaller that it would not just stop it. It would turn around and we don't have good news in that regard. But overall we're getting benefit out of the chemotherapy and I think it's worth continuing. Okay. So you mentioned that there would stop the tax halt some some point and just continue on the herceptin was that part of the yes, that will be our plan because okay acceptance not giving you side effects. So we're going to balance our taxol with what's the standard treatment and your side effects because that could make us stop sooner. Okay, but not at this point. Okay still planning a six-month course six months. Okay. All right. Well, that's very good to know great. Well, what I would want to know is if these things are getting worse in any way such that you really are having trouble getting a shower getting your mail Etc. And so that you there things that you reach a limit withYou can't do in which case I would."
#document = "Hello, my name is dr. Halstead. I'm a medical oncologist and here with Deborah 45 year old woman who is a nurse assistant with metastatic recurrent breast cancer to her, right? Yo monk this initially stage 1A infiltrating ductal. Carcinoma Deborah. How are you doing today? I'm not doing very well here what's been going on? So it appears that I've had more numbness and tingling in my fingers my hands my feet. This is really affecting a lot of what I need to do during the day or during know is this has this when did this start the started shortly after my new treatment OD taxol and their acceptance? Yeah. Okay. So those those medications are part of the the new regimen that we started six weeks ago. Right? Right. Gotcha. Well that's interesting. You know just something.twoThese toxicities are side effects the muscle aches you're describing as you mentioned tingling. Yes. So the peripheral sensory neuropathy. Those are common side effects or toxicities that are associated with with those two medications something to certainly be concerned about my I guess a follow-up question I have is are these are the is the numbness and tingling. Is it affecting your normal day-to-day activities? Well, there's I'm having trouble going up and down the stairs. I'm having trouble getting in and out of the shower even getting dressed. I'm just wondering how long does numbness and tingling or going to occur? I mean, is this something that's that we think is going to happen for a couple of weeks or it's a great question. So hopefully these side effects will one not get worse and to hopefully subside because they're related to the medication. So the toxicities areLeader be permanent in that sense. They should go away but it's something that we should keep track of and ensure that they don't get worse so that if your activities of daily living are getting more pronounced Lee affected, we should probably consider different treatment regimens and taking there's no medications. How long are they going to stay sort of in my system? I mean over time are they going to diminish they should diminish over time? Yeah. It should be something that you know, stay in your system for a week or two, but then should be flushed out. And is there something else I can do either another medication to try to reduce the symptoms of a feeling or changed my diet steering question. So unfortunately, there's nothing really that can be done other than just resting and taking it easy if you have trouble if you have worst"

class Chunker
  attr_accessor :chunks, :context_length_left, :context_length_right
  def initialize (target, context_length)
    @target = target # what kinds of chunks are we looking for? :toxicity, :disease_status
    @context_length_left = @context_length_right = context_length # number of characters to each side of keyword we should include in the chunk
    @chunks = []
  end
  
  def run(document)
    toxicity_keywords = case @target
                        when :toxicity
                          [
                            /toxicit(y|ies)/i, #also use global? /g?
                            /side effects?/i,
                            /symotoms?/i,
                            /start(ed|ing).{0,50}(medic(ations?|ines?)|treatment|regimen).{0,100}(experienc(ed?|ing)?|feel(ing)?|affect(s|ed|ing)?)/i, # effort to capture patient description of their sides effects and symptoms
                          	/(experienc(ed?|ing)?|feel(ing)?|affect(s|ed|ing)?).{0,100}start(ed|ing).{0,50}(medic(ations?|ines?)|treatment|regimen)/i  # same purpose as pervious, can these two lines be combined?
                          ]
                        when :disease_status
                          [ # TODO: this is dopey. duplication of search expressions between here and the status_value patterns in DiseaseStatusExtractor should be abstracted and merged.
                            /((not? )|(complete ))?(stable|progressing|responding|response( to treatment)?|resection|inevaluable|changed?|getting worse|worsening|getting better|improving|(stayed )?exactly (the same|as they have been)|updates?|results?)/i
                          ]
                        else
                          raise "Unknown chunking target: #{@target}"
                        end
    
    matches = []
    toxicity_keywords.each do |key| # each keyword is actually a regex pattern
      # consider converting to AnnotatedString and creating a Standoff tag if we want to do more with the keyword position later
      matches += document.to_enum(:scan, key).map { Regexp.last_match } # this would be just key.match document, but we want MatchData for possible multiple keyword matches, not just one
    end
    
    # for now, naive chunker just grabs a window of a constant character width centered around each key found
    # this will almost certainly need to get smarter (by using token, sentence, and speaker boundaries, and/or trained models or syntax)
    chunk_windows_by_start_and_end_positions = matches.map do |m|
      chunk_start = [0, m.begin(0) - @context_length_left].max # expand chunk to the left from the key. make sure we have a non-negative start position so it doesn't wrap around to the end
      chunk_end = [document.length, m.end(0) + @context_length_right].min # ditto to the right
      [chunk_start, chunk_end]
    end
    
    # merge overlapping chunks; the merging iterator relies on the order provided by .sort!
    chunk_windows_by_start_and_end_positions.sort!
    chunk_windows_by_start_and_end_positions.each_with_index do |positions, i|
      chunk_start, chunk_end = positions
      while i+1 < chunk_windows_by_start_and_end_positions.length && chunk_windows_by_start_and_end_positions[i+1].first < chunk_end
        chunk_end = chunk_windows_by_start_and_end_positions[i+1].last
        chunk_windows_by_start_and_end_positions.delete_at i+1
      end
      
      chunk_length = chunk_end - chunk_start + 1
      @chunks << document.slice(chunk_start, chunk_length)
    end
    @chunks.compact!
  end
end



#c = Chunker.new(:toxicity,150)
#c.run document
#puts c.chunks.inspect
